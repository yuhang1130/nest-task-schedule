# 脚本下发服务技术架构文档

## 1. 系统概述

send-script-main 是一个基于 Node.js cluster 模块构建的多进程脚本下发服务，主要负责将脚本任务分发到下游设备进行执行。该服务采用 Master-Worker 架构模式，通过 Redis 队列、延迟队列和设备锁机制实现任务的可靠分发和执行。

## 2. 技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Send Script Service                         │
├─────────────────────────────────────────────────────────────────┤
│  Entry Point: src/microservices/send-script-main.ts            │
│                                                                 │
│  Master Process                    Worker Processes             │
│  ┌─────────────────────────┐      ┌─────────────────────────┐  │
│  │ SendScriptMasterService │      │ SendScriptWorkerService │  │
│  │                         │      │                         │  │
│  │ • Child Process Mgmt    │◄────►│ • Task Processing      │  │
│  │ • Task Scheduling       │ IPC  │ • Device Lock Mgmt     │  │
│  │ • Load Balancing        │      │ • Script Dispatch     │  │
│  │ • Timeout Monitoring    │      │ • Status Updates       │  │
│  └─────────────────────────┘      └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                    │                              │
                    ▼                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   External Systems                              │
├─────────────────────────────────────────────────────────────────┤
│  Redis                    MongoDB              Pulsar MQ        │
│  ┌─────────────────┐     ┌─────────────────┐   ┌─────────────┐  │
│  │ • Task Queue    │     │ • Task Records  │   │ • Log Msgs  │  │
│  │ • Device Locks  │     │ • Script Codes  │   │ • Results   │  │
│  │ • Delay Queue   │     │ • Exec Records  │   │             │  │
│  └─────────────────┘     └─────────────────┘   └─────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                   ┌─────────────────────────────┐
                   │     Central Control API     │
                   │   (Device Management)       │
                   └─────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 进程管理层
- **入口文件**: `src/microservices/send-script-main.ts`
- **功能**: 基于 Node.js cluster 模块创建 Master 和 Worker 进程
- **进程通信**: 使用 `@nestjs/event-emitter` 实现 IPC 通信

#### 2.2.2 Master 进程 (SendScriptMasterService)
**位置**: `src/modules/send-script-main/send-script-master.service.ts`

**核心职责**:
- 创建和管理 Worker 进程 (默认2个)
- 任务队列管理和负载均衡
- 定时任务调度
- 异常监控和故障恢复

**定时任务**:
- **任务检查** (5秒间隔): 检查延迟队列，分发任务给 Worker
- **数据加载** (5分钟间隔): 从数据库加载预约执行任务到延迟队列
- **超时检查** (10分钟间隔): 检查执行超时任务，更新状态

#### 2.2.3 Worker 进程 (SendScriptWorkerService)
**位置**: `src/modules/send-script-main/send-script-worker.service.ts`

**核心职责**:
- 接收 Master 分发的任务
- 设备锁获取和管理
- 脚本下发执行
- 任务状态更新

### 2.3 数据层设计

#### 2.3.1 MongoDB 集合
- **ScriptTaskEntity**: 脚本任务主表
- **ScriptCodeEntity**: 脚本代码存储
- **ScriptTaskExecRecordEntity**: 任务执行记录快照
- **ScriptTaskLogEntity**: 任务执行日志

#### 2.3.2 Redis 数据结构
- **任务队列**: 存储待执行的任务ID和设备ID
- **设备锁**: 防止同一设备并发执行多个任务
- **延迟队列**: 内存中的预约任务队列

## 3. 业务流程

### 3.1 任务创建流程
1. **生产者** (`script-task.service.ts:create`) 创建任务
2. 立即执行任务 → Redis 任务队列
3. 预约执行任务 → 数据库存储，等待定时加载

### 3.2 任务执行流程
1. **Master** 从 Redis 队列获取任务
2. 任务放入内存延迟队列
3. 定时器检查延迟队列，选择 Worker 执行
4. **Worker** 获取设备锁，创建执行记录
5. 执行脚本下发，更新状态为"发送成功"

### 3.3 结果处理流程
1. **Pulsar Consumer** 接收中控服务推送的执行日志
2. 根据日志类型更新任务状态:
   - `SUCCESS` → 任务成功
   - `ERROR/SYSTEM_ERROR` → 任务失败或失败待重试
3. 所有日志入库存储

## 4. 关键特性

### 4.1 负载均衡
- **设备维度负载均衡**: 优先分配给未处理该设备的 Worker
- **任务数量平衡**: 选择任务数最少的 Worker

### 4.2 容错机制
- **设备锁机制**: 防止设备并发执行
- **失败重试**: 支持任务失败后自动重试
- **超时处理**: 定时检查执行超时任务
- **进程故障恢复**: Worker 进程异常自动重启

### 4.3 可观测性
- **执行记录**: 每次执行创建独立快照
- **日志收集**: 完整的执行日志记录
- **状态跟踪**: 详细的任务状态流转

## 5. 状态管理

### 5.1 任务状态流转
```
Waiting → Running → Send_Success → Success/Failed
   ↓         ↓
Canceled  Failed_Waiting_Retry → (重试) → Running
```

### 5.2 执行记录状态
```
Running → Success/Failed/Canceled
```

## 6. 性能特性

- **多进程并发**: Master-Worker 架构提高并发处理能力
- **内存队列**: 热点数据缓存减少数据库压力
- **批量处理**: MQ 消息批量处理提高吞吐量
- **设备锁控制**: 避免设备资源冲突

## 7. 扩展性设计

- **水平扩展**: 可调整 Worker 进程数量
- **队列扩展**: Redis 队列支持分片扩展
- **插件化**: 可扩展不同类型的脚本处理器

---

*文档版本: v1.0*  
*最后更新: 2025-09-29*