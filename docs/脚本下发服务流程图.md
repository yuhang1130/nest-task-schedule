# 脚本下发服务业务流程图

## 1. 详细流程图

### 1.1 任务创建与入队流程

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant TaskSvc as web服务
    participant CentralAPI as 中控API
    participant MongoDB as MongoDB
    participant Redis as Redis队列
    
    Client->>TaskSvc: 创建脚本任务
    TaskSvc->>CentralAPI: 验证设备存在性
    CentralAPI-->>TaskSvc: 设备信息
    TaskSvc->>TaskSvc: 验证脚本代码
    
    Note over TaskSvc: 创建任务记录
    TaskSvc->>MongoDB: 保存ScriptTaskEntity
    TaskSvc->>MongoDB: 保存ScriptCodeEntity
    
    alt 立即执行
        TaskSvc->>Redis: 推送到任务队列
    else 预约执行
        Note over TaskSvc: 等待定时器加载
    end
    
    TaskSvc-->>Client: 返回任务ID
```

### 2.2 Master进程任务调度流程

```mermaid
graph TB
    A[Master进程启动] --> B[创建Worker进程]
    B --> C[建立IPC通信]
    C --> D[动态创建定时器]
    
    D --> E[Redis队列监听]
    D --> F[任务检查器-5秒]
    D --> G[数据加载器-5分]
    D --> H[超时检查器-10分]
    
    E --> I[接收任务消息]
    I --> J[放入刷新队列]
    
    F --> K[检查刷新队列]
    K --> L[转移到等待队列]
    L --> M[任务分发]
    
    G --> N[查询待执行任务]
    N --> O[加载到刷新队列]
    
    H --> P[检查超时任务-30分]
    P --> Q[更新为失败或待重试状态]
    
    M --> R[选择Worker进程]
    R --> S[发送IPC消息]
```

### 2.3 Worker进程任务处理流程

```mermaid
flowchart TD
    A[Worker接收任务] --> B[解析任务消息]
    B --> C[获取设备锁]
    C --> D{设备锁获取成功?}
    
    D -->|失败| E[更新任务失败]
    E --> F[任务失败待重试]
    F --> G[发送完成通知]
    
    D -->|成功| H[查询任务记录]
    H --> I{任务存在且可执行?}
    I -->|否| J[记录警告日志]
    J --> G
    
    I -->|是| K[创建执行记录快照]
    K --> L[更新任务状态-运行中]
    L --> M[failed_waiting_retry ?? 执行重试次数++]
    M --> N[任务预处理]
    N --> O[下发脚本到中控]
    
    O --> P{下发成功?}
    P -->|成功| Q[更新状态-发送成功]
    Q --> G
    
    P -->|失败| R[处理运行失败]
    R --> S{需要重试?}
    S -->|是| T[更新为失败待重试]
    S -->|否| U[更新为最终失败]
    T --> G
    U --> G
```

### 2.4 负载均衡算法流程

```mermaid
flowchart TD
    A[选择Worker进程] --> B[获取就绪Worker列表]
    B --> C{有设备ID?}
    
    C -->|否| D[选择任务数最少的Worker]
    D --> E[更新Worker统计]
    E --> F[发送任务]
    
    C -->|是| G[查找未处理该设备的Worker]
    G --> H{找到可用Worker?}
    
    H -->|是| I[选择任务数最少的可用Worker]
    I --> E
    
    H -->|否| J[按设备任务数排序]
    J --> K[选择该设备任务最少的Worker]
    K --> L[更新设备任务统计]
    L --> E
```

### 2.5 MQ消息处理流程

```mermaid
sequenceDiagram
    participant Control as 中控服务
    participant Pulsar as Pulsar MQ
    participant Consumer as PulsarMessageService
    participant TaskSvc as ScriptTaskService
    participant LogSvc as TaskExecLogService
    participant MongoDB as MongoDB
    participant Redis as Redis锁
    
    Control->>Pulsar: 推送执行日志
    Pulsar->>Consumer: 批量接收消息
    
    Note over Consumer: 按日志类型分类
    Consumer->>Consumer: 分离成功/失败消息
    
    par 并行处理
        Consumer->>LogSvc: 保存所有日志
        LogSvc->>MongoDB: 批量插入日志记录
    and
        Consumer->>TaskSvc: 处理成功消息
        TaskSvc->>MongoDB: 更新任务状态为成功
        TaskSvc->>MongoDB: 更新执行记录状态
        TaskSvc->>Redis: 释放设备锁
    and
        Consumer->>TaskSvc: 处理失败消息
        TaskSvc->>TaskSvc: 判断是否需要重试
        TaskSvc->>MongoDB: 更新任务状态
        TaskSvc->>Redis: 释放设备锁
    end
    
    Consumer->>Pulsar: 确认消息处理完成
```

### 2.6 设备锁管理流程

```mermaid
graph TB
    A[任务开始执行] --> B[尝试获取设备锁]
    B --> C{锁获取成功?}
    
    C -->|失败| D[任务标记失败]
    D --> E[消耗重试次数]
    E --> F[任务结束]
    
    C -->|成功| G[记录锁值到执行记录]
    G --> H[执行脚本下发]
    H --> I[等待执行结果]
    
    I --> J{收到MQ消息?}
    J -->|成功消息| K[任务标记成功]
    J -->|失败消息| L[任务标记失败]
    J -->|超时| M[定时器检查超时]
    
    K --> N[释放设备锁]
    L --> O{需要重试?}
    O -->|是| P[设置下次执行时间]
    O -->|否| Q[任务最终失败]
    P --> N
    Q --> N
    M --> R[强制释放锁]
    
    N --> F
    R --> F
```

## 3. 状态流转图

### 3.1 任务状态流转

```mermaid
stateDiagram-v2
    [*] --> Waiting : 任务创建
    
    Waiting --> Running : Worker开始执行
    Waiting --> Canceled : 用户取消
    
    Running --> Send_Success : 脚本下发成功
    Running --> Failed_Waiting_Retry : 下发失败(可重试)
    Running --> Failed : 下发失败(不可重试)
    Running --> Canceled : 用户取消
    
    Send_Success --> Success : 收到成功MQ消息
    Send_Success --> Failed_Waiting_Retry : 收到失败MQ消息(可重试)
    Send_Success --> Failed : 收到失败MQ消息(不可重试)
    Send_Success --> Failed : 执行超时
    
    Failed_Waiting_Retry --> Running : 重试执行
    Failed_Waiting_Retry --> Failed : 超过最大重试次数
    Failed_Waiting_Retry --> Canceled : 用户取消
    
    Success --> [*]
    Failed --> [*]
    Canceled --> [*]
```

### 3.2 执行记录状态流转

```mermaid
stateDiagram-v2
    [*] --> Running : 创建执行记录
    
    Running --> Success : 任务执行成功
    Running --> Failed : 任务执行失败
    Running --> Canceled : 任务被取消
    
    Success --> [*]
    Failed --> [*]
    Canceled --> [*]
```

## 4. 异常处理流程

### 4.1 Worker进程故障恢复

```mermaid
sequenceDiagram
    participant Master as Master进程
    participant Worker as Worker进程
    participant IPC as IPC通信
    participant MongoDB as MongoDB
    
    Worker->>IPC: 进程异常退出
    IPC->>Master: 接收退出信号
    
    Note over Master: 检查退出码
    alt 异常退出 (code != 0)
        Master->>Master: 从Worker列表移除
        Master->>MongoDB: 将处理中任务标记为系统错误
        Master->>Master: 创建新Worker进程
        Master->>IPC: 建立新的IPC通信
        Master->>Master: 添加到Worker列表
    else 正常退出 (code == 0)
        Master->>Master: 清理Worker信息
    end
```

### 4.2 设备锁超时处理

```mermaid
flowchart TD
    A[定时检查超时任务] --> B[查询发送成功且超时的任务]
    B --> C[获取执行记录]
    C --> D[检查设备锁状态]
    D --> E{锁是否存在?}
    
    E -->|存在| F[强制释放锁]
    E -->|不存在| G[锁已自动过期]
    
    F --> H[更新任务状态]
    G --> H
    H --> I{允许重试?}
    
    I -->|是| J[设置为失败待重试]
    I -->|否| K[设置为最终失败]
    
    J --> L[设置下次执行时间]
    K --> M[记录失败原因]
    L --> N[完成处理]
    M --> N
```

---

*文档版本: v1.0*  
*最后更新: 2025-09-29*